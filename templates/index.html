<script>
  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    const name = localStorage.getItem("fullName") || "User";
    const language = document.getElementById("language").value;
    const level = document.getElementById("level").value;
    const topic = document.getElementById("programmingLanguage").value;

    appendMessage(name, message, true);

    const botBubble = appendMessage("DigitITBot", "âŒ› Thinking...", false);
    const response = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message,
        userName: name,
        language,
        level,
        topic,
      }),
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let accumulated = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      accumulated += decoder.decode(value, { stream: true });
      botBubble.innerText = accumulated;
    }

    botBubble.innerText = accumulated;
    userInput.value = "";
  }
</script>