<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DigitITBot Tutor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    #chat-container, #quiz-container { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fff; margin-bottom: 20px; overflow-y: auto; max-height: 400px; }
    .user-bubble { background: #007bff; color: white; padding: 10px; margin: 5px; border-radius: 15px; text-align: right; max-width: 70%; float: right; clear: both; }
    .bot-bubble { background: #e9ecef; color: #333; padding: 10px; margin: 5px; border-radius: 15px; text-align: left; max-width: 70%; float: left; clear: both; }
    #message-form { display: flex; margin-top: 10px; }
    #message-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    #send-button { padding: 10px 20px; margin-left: 5px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer; }
    .quiz-question { margin-bottom: 15px; }
    .quiz-feedback.correct { color: green; }
    .quiz-feedback.incorrect { color: red; }
    button.quiz-submit { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ðŸ“˜ DigitITBot Tutor</h1>

    <div id="chat-container"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="Type your message here..." required />
      <button type="submit" id="send-button">Send</button>
    </form>

    <div id="quiz-container"></div>
    <button id="start-quiz">Start Quiz</button>
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const form = document.getElementById("message-form");
    const input = document.getElementById("message-input");
    const quizContainer = document.getElementById("quiz-container");
    const startQuizBtn = document.getElementById("start-quiz");

    let currentQuiz = [];

    function addMessage(role, message) {
      const msgDiv = document.createElement("div");
      msgDiv.className = role === "user" ? "user-bubble" : "bot-bubble";
      msgDiv.innerHTML = marked.parse(message);
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = input.value;
      if (!message) return;

      addMessage("user", message);
      input.value = "";

      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await response.json();
        addMessage("bot", data.response);
      } catch (err) {
        addMessage("bot", "Oops! Something went wrong.");
        console.error(err);
      }
    });

    startQuizBtn.addEventListener("click", async () => {
      try {
        const response = await fetch("/quiz/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic: "ITIL", num_questions: 5 })
        });
        const data = await response.json();
        currentQuiz = data.questions;
        renderQuiz();
      } catch (err) {
        alert("Failed to load quiz.");
        console.error(err);
      }
    });

    function renderQuiz() {
      quizContainer.innerHTML = "";
      currentQuiz.forEach((q, idx) => {
        const qDiv = document.createElement("div");
        qDiv.className = "quiz-question";
        qDiv.innerHTML = `<strong>${q.question}</strong><br>`;
        q.options.forEach(opt => {
          const id = `q${idx}_${opt}`;
          qDiv.innerHTML += `
            <input type="radio" name="q${idx}" id="${id}" value="${opt}">
            <label for="${id}">${opt}</label><br>
          `;
        });
        quizContainer.appendChild(qDiv);
      });

      const submitBtn = document.createElement("button");
      submitBtn.className = "quiz-submit";
      submitBtn.innerText = "Submit Quiz";
      submitBtn.onclick = submitQuiz;
      quizContainer.appendChild(submitBtn);
    }

    async function submitQuiz() {
      const answers = currentQuiz.map((q, idx) => {
        const selected = document.querySelector(`input[name="q${idx}"]:checked`);
        return selected ? selected.value : null;
      });

      try {
        const response = await fetch("/quiz/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ answers, questions: currentQuiz })
        });
        const data = await response.json();
        displayFeedback(data);
      } catch (err) {
        alert("Failed to submit quiz.");
        console.error(err);
      }
    }

    function displayFeedback(result) {
      quizContainer.innerHTML = `<h3>Score: ${result.score} / ${result.total}</h3>`;
      result.feedback.forEach(fb => {
        const fbDiv = document.createElement("div");
        fbDiv.className = "quiz-feedback " + (fb.correct ? "correct" : "incorrect");
        fbDiv.innerHTML = fb.correct ? `âœ” ${fb.question}` : `âœ– ${fb.question} (Correct: ${fb.correct_answer})`;
        quizContainer.appendChild(fbDiv);
      });
    }
  </script>
</body>
</html>
