<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DigitITBot Tutor</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div id="app">
    <header>
      <h1>üìò DigitITBot Tutor</h1>
      <p>Your AI-powered IT Tutor & Quiz Assistant</p>
    </header>

    <!-- Chat Section -->
    <section id="chat-section">
      <div id="chat-box"></div>
      <input type="text" id="user-input" placeholder="Ask a question..." />
      <button id="send-btn">Send</button>
    </section>

    <hr />

    <!-- Quiz Section -->
    <section id="quiz-section">
      <h2>üéØ Quiz Mode</h2>

      <!-- Topic Selector -->
      <label for="quiz-topic">Choose a Topic:</label>
      <select id="quiz-topic">
        <option value="ITIL">ITIL</option>
        <option value="Cloud">Cloud</option>
        <option value="ServiceNow">ServiceNow</option>
        <option value="DevOps">DevOps</option>
        <option value="Networking">Networking</option>
      </select>

      <!-- Number of Questions -->
      <label for="quiz-count">Number of Questions:</label>
      <input type="number" id="quiz-count" min="1" max="10" value="5" />

      <button id="start-quiz">Start Quiz</button>

      <!-- Quiz Timer -->
      <div id="quiz-timer"></div>

      <!-- Quiz Questions Render -->
      <div id="quiz-container"></div>

      <!-- Submit Quiz -->
      <button id="submit-quiz" style="display:none;">Submit Quiz</button>

      <!-- Results -->
      <div id="quiz-results"></div>
    </section>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    sendBtn.addEventListener("click", async () => {
      const message = userInput.value;
      if (!message) return;

      chatBox.innerHTML += `<div class='user-msg'>${message}</div>`;
      userInput.value = "";

      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message })
      });
      const data = await res.json();

      chatBox.innerHTML += `<div class='bot-msg'>${data.response}</div>`;
    });

    // Quiz Logic
    const startQuizBtn = document.getElementById("start-quiz");
    const quizContainer = document.getElementById("quiz-container");
    const quizResults = document.getElementById("quiz-results");
    const submitQuizBtn = document.getElementById("submit-quiz");
    const quizTimerEl = document.getElementById("quiz-timer");

    let quizQuestions = [];
    let userAnswers = [];
    let timer;

    startQuizBtn.addEventListener("click", async () => {
      const topic = document.getElementById("quiz-topic").value;
      const count = document.getElementById("quiz-count").value;

      const res = await fetch("/quiz/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ topic: topic, num_questions: count })
      });

      const data = await res.json();
      quizQuestions = data.questions;
      userAnswers = Array(quizQuestions.length).fill(null);

      renderQuiz();
      startTimer(60); // 1-minute timer
    });

    function renderQuiz() {
      quizContainer.innerHTML = "";
      quizResults.innerHTML = "";
      quizQuestions.forEach((q, i) => {
        let optionsHTML = q.options.map(opt => `
          <label>
            <input type="radio" name="q${i}" value="${opt.charAt(0)}" onchange="saveAnswer(${i}, this.value)">
            ${opt}
          </label><br>
        `).join("");

        quizContainer.innerHTML += `
          <div class="quiz-question">
            <p><b>Q${i+1}:</b> ${q.question}</p>
            ${optionsHTML}
          </div>
        `;
      });

      submitQuizBtn.style.display = "block";
    }

    function saveAnswer(index, value) {
      userAnswers[index] = value;
    }

    submitQuizBtn.addEventListener("click", submitQuiz);

    async function submitQuiz() {
      clearInterval(timer);
      const res = await fetch("/quiz/submit", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ answers: userAnswers, questions: quizQuestions })
      });
      const data = await res.json();

      quizResults.innerHTML = `<h3>‚úÖ You scored ${data.score}/${data.total}</h3>`;
      data.feedback.forEach(f => {
        if (f.correct) {
          quizResults.innerHTML += `<p>‚úîÔ∏è ${f.question} - Correct</p>`;
        } else {
          quizResults.innerHTML += `<p>‚ùå ${f.question} - Correct Answer: ${f.correct_answer}</p>`;
        }
      });

      submitQuizBtn.style.display = "none";
    }

    function startTimer(duration) {
      let timeLeft = duration;
      quizTimerEl.innerText = `‚è≥ Time left: ${timeLeft}s`;

      timer = setInterval(() => {
        timeLeft--;
        quizTimerEl.innerText = `‚è≥ Time left: ${timeLeft}s`;

        if (timeLeft <= 0) {
          clearInterval(timer);
          submitQuiz();
        }
      }, 1000);
    }

    // Expose saveAnswer globally
    window.saveAnswer = saveAnswer;
  </script>
</body>
</html>
